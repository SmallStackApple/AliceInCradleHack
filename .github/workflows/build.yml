name: Build & Release .NET 4.7.2 (Tag Trigger)

# 仅在推送Tag时触发（满足「带版本tag就打包发布」的需求）
on:
  push:
    tags:
      - '*' # 匹配所有Tag（也可限定格式如 v*、prerelease*）

jobs:
  build-and-publish:
    runs-on: windows-latest
    steps:
      # 1. 拉取仓库代码（包含Tag信息）
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 确保能获取完整Tag信息

      # 2. 安装VS Build Tools（适配.NET Framework 4.7.2构建）
      - name: Setup MSBuild (.NET 4.7.2)
        uses: microsoft/setup-msbuild@v2
        with:
          msbuild-architecture: x64 # 适配64位构建（按需改为x86）
          workloads: |
            # 安装桌面程序构建工具
            Microsoft.VisualStudio.Workload.ManagedDesktopBuildTools
            # 安装.NET 4.7.2 Targeting Pack（核心：匹配项目框架版本）
            Microsoft.Net.Component.4.7.2.TargetingPack

      # 3. 还原NuGet依赖（若项目有NuGet包引用）
      - name: Restore NuGet Packages
        run: nuget restore AliceInCradleHack/AliceInCradleHack.sln
        # 若没有sln文件，替换为csproj路径：nuget restore AliceInCradleHack/AliceInCradleHack.csproj

      # 4. 构建Release版本（x64，输出到指定目录）
      - name: Build Project (Release x64)
        run: |
          msbuild AliceInCradleHack/AliceInCradleHack.sln `
            /t:Build `
            /p:Configuration=Release `
            /p:Platform=x64 `
            /p:OutputPath=./bin/Release/x64 `
            /m # 多核构建加速
        shell: pwsh

      # 5. 打包构建产物（生成带Tag名称的ZIP包）
      - name: Package Build Output
        run: |
          $tagName = "${{ github.ref_name }}"
          # 打包Release目录下的所有文件为ZIP（名称包含Tag）
          Compress-Archive -Path ./bin/Release/x64/* -DestinationPath ./AliceInCradleHack_$tagName.zip
        shell: pwsh

      # 6. 判断Tag是否以prerelease开头（决定是否为预发布）
      - name: Determine Release Type
        id: release_type
        run: |
          $tagName = "${{ github.ref_name }}"
          # 匹配以prerelease开头的Tag（不区分大小写，按需可去掉-creplace）
          if ($tagName -replace '^prerelease','' -ne $tagName) {
              echo "prerelease=true" >> $env:GITHUB_OUTPUT
          } else {
              echo "prerelease=false" >> $env:GITHUB_OUTPUT
          }
        shell: pwsh

      # 7. 发布到GitHub Releases（核心：根据Tag前缀设置预发布）
      - name: Publish to GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          # 发布标题（使用Tag名称）
          name: Release ${{ github.ref_name }}
          # 预发布标记：Tag以prerelease开头则为true
          prerelease: ${{ steps.release_type.outputs.prerelease }}
          # 上传打包的ZIP包（作为发布附件）
          files: ./AliceInCradleHack_${{ github.ref_name }}.zip
          # 可选：自动生成发布说明（也可手动写body）
          generate_release_notes: true
        env:
          # GitHub自动生成的Token，无需手动配置（默认有发布权限）
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
